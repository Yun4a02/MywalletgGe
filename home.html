
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Tabungan</title>
  <link rel="stylesheet" href="home.css"/>
</head>
<body>
  <div class="dashboard">
    <header>
      <h1 id="username">Selamat Datang, User 👋</h1>
      <div class="theme-toggle">
        <div class="user-info">
          <img id="user-avatar-header" src="profile-default-avatar.png" alt="Foto" width="48" height="48">
          <span id="user-name-header" class="profile-name">User</span>
        </div>
        <label for="darkModeToggle" id="modeIcon">☀︎</label>
        <input type="checkbox" id="darkModeToggle" />
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <section class="summary">
      <div class="card"><h2>Total Tabungan</h2><p id="total-tabungan">Rp 0</p></div>
      <div class="card"><h2>Pemasukan</h2><p id="total-masuk">Rp 0</p></div>
      <div class="card"><h2>Pengeluaran</h2><p id="total-keluar">Rp 0</p></div>
    </section>

    <section class="transaction-add">
      <h2>Tambah Transaksi</h2>
      <form id="add-form">
        <input type="date" id="tanggal" required />
        <input type="text" id="keterangan" placeholder="Keterangan" required />
        <select id="jenis" required>
          <option value="Pemasukan">Pemasukan</option>
          <option value="Pengeluaran">Pengeluaran</option>
        </select>
        <input type="text" id="jumlah" placeholder="Jumlah" required />
        <button type="submit"><span>Tambah</span></button>
      </form>
    </section>

    <section class="transaction">
      <h2>Riwayat Transaksi</h2>
      <table id="transaction-table">
        <thead>
          <tr>
            <th>Tanggal</th><th>Keterangan</th><th>Jenis</th><th>Jumlah</th><th>User</th><th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <footer><p>© 2025 My Wallet | Tabungan App</p></footer>
  </div>

  <script>
    let user = JSON.parse(localStorage.getItem("user") || "{}");
    const storedTransactions = JSON.parse(localStorage.getItem("transactions") || "[]");

    document.addEventListener("DOMContentLoaded", () => {
      const isLoggedIn = localStorage.getItem("loggedIn");
      if (isLoggedIn !== "true" || !user) {
        window.location.href = "login.html";
        return;
      }

      document.getElementById("username").textContent = "Selamat Datang, " + (user.name || "User") + " 👋";
      document.getElementById("user-name-header").textContent = user.name || "User";
      document.getElementById("user-avatar-header").src = user.avatar || "profile-default-avatar.png";

      document.getElementById("darkModeToggle").checked = localStorage.getItem("theme") === "dark";
      toggleTheme();

      document.getElementById("darkModeToggle").addEventListener("change", toggleTheme);
      document.getElementById("add-form").addEventListener("submit", addTransaction);

      document.getElementById("jumlah").addEventListener("input", e => {
        e.target.value = new Intl.NumberFormat("id-ID").format(e.target.value.replace(/\D/g, ""));
      });

      updateDashboard();
    });

    function formatRupiah(amount) {
      return 'Rp ' + amount.toLocaleString('id-ID');
    }

    function updateDashboard() {
      const tbody = document.querySelector("#transaction-table tbody");
      const totalTabungan = document.getElementById("total-tabungan");
      const totalMasukEl = document.getElementById("total-masuk");
      const totalKeluarEl = document.getElementById("total-keluar");

      const transactions = JSON.parse(localStorage.getItem("transactions") || "[]");

      tbody.innerHTML = "";
      let totalMasuk = 0, totalKeluar = 0;

      transactions.forEach((t, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${t.tanggal}</td>
          <td>${t.keterangan}</td>
          <td class="${t.jenis === 'Pemasukan' ? 'masuk' : 'keluar'}">${t.jenis}</td>
          <td>${formatRupiah(t.jumlah)}</td>
          <td>${t.user || "-"}</td>
          <td><button onclick="deleteTransaction(${index})">Hapus</button></td>`;
        tbody.appendChild(row);

        if (t.jenis === "Pemasukan") totalMasuk += t.jumlah;
        else totalKeluar += t.jumlah;
      });

      totalTabungan.textContent = formatRupiah(totalMasuk - totalKeluar);
      totalMasukEl.textContent = formatRupiah(totalMasuk);
      totalKeluarEl.textContent = formatRupiah(totalKeluar);
    }

    function addTransaction(e) {
      e.preventDefault();
      const tanggal = document.getElementById("tanggal").value;
      const keterangan = document.getElementById("keterangan").value;
      const jenis = document.getElementById("jenis").value;
      const jumlah = parseInt(document.getElementById("jumlah").value.replace(/\./g, ""));

      if (!jumlah || jumlah <= 0) return alert("Jumlah tidak valid");

      const newTx = { tanggal, keterangan, jenis, jumlah, user: user.name || "User" };
      const allTx = JSON.parse(localStorage.getItem("transactions") || "[]");
      allTx.push(newTx);
      localStorage.setItem("transactions", JSON.stringify(allTx));
      updateDashboard();
      e.target.reset();
    }

    function deleteTransaction(index) {
      if (!confirm("Yakin hapus transaksi?")) return;
      const allTx = JSON.parse(localStorage.getItem("transactions") || "[]");
      allTx.splice(index, 1);
      localStorage.setItem("transactions", JSON.stringify(allTx));
      updateDashboard();
    }

    function logout() {
      localStorage.removeItem("loggedIn");
      window.location.href = "login.html";
    }

    function toggleTheme() {
      const theme = document.getElementById("darkModeToggle").checked ? "dark" : "light";
      document.body.classList.toggle("dark-mode", theme === "dark");
      localStorage.setItem("theme", theme);
      document.getElementById("modeIcon").textContent = theme === "dark" ? "⏾" : "☀︎";
    }

    function syncUserProfile() {
      user = JSON.parse(localStorage.getItem("user") || "{}");
      document.getElementById("user-name-header").textContent = user.name || "User";
      document.getElementById("user-avatar-header").src = user.avatar || "profile-default-avatar.png";
      document.getElementById("username").textContent = "Selamat Datang, " + (user.name || "User") + " 👋";
    }

    // Listen to localStorage changes (from other tabs)
    window.addEventListener("storage", function (event) {
      if (event.key === "transactions") updateDashboard();
      if (event.key === "user") syncUserProfile();
    });
  </script>
</body>
</html>
